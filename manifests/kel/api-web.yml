apiVersion: v1
kind: Service
metadata:
  name: api-web
  namespace: kel-system
  labels:
    kelproject.com/cluster-service: "true"
    kelproject.com/name: api-web
  annotations:
    router: '{"config": {}, "hosts": ["{{ cluster.config.api.host }}"]}'
spec:
  selector:
    kelproject.com/name: api-web
  ports:
    - port: 80
      protocol: TCP
      targetPort: 8000

---

apiVersion: v1
kind: ReplicationController
metadata:
  name: api-web-{{ version }}
  namespace: kel-system
  labels:
    kelproject.com/name: api-web
    version: {{ version }}
spec:
  replicas: {{ replicas }}
  selector:
    kelproject.com/name: api-web
    version: {{ version }}
  template:
    metadata:
      labels:
        kelproject.com/name: api-web
        version: {{ version }}
    spec:
      containers:
      - name: api-web
        image: {{ image }}
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 100m
            memory: 476Mi
        args:
          - start
          - web
        env:
          - name: BUNDLE_URL
            value: https://storage.googleapis.com/release.kelproject.com/bundles/api/api-{{ bundle }}.tgz
          - name: PORT
            value: "8000"
          - name: DJANGO_SETTINGS_MODULE
            value: kel.api.settings_production
          - name: KEL_ENV_SECRETS_PATH
            value: /etc/api-env
          - name: ETCD_ENDPOINTS
            value: {{ cluster.get_etcd_endpoints()|join(",") }}
        ports:
          - containerPort: 8000
            protocol: TCP
        volumeMounts:
          - mountPath: /etc/api-env
            name: api-env
            readOnly: true
      nodeSelector:
        kelproject.com/node-kind: node-1x
      volumes:
        - name: api-env
          secret:
            secretName: api-web-env

---

apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: api-web-env
  namespace: kel-system
data:
  cluster-name: {{ b64(cluster.config.name) }}
  cluster-api-host: {{ b64(cluster.config.api.host) }}
  cluster-domain: {{ b64(cluster.config.domain) }}
  gce-project-id: {{ b64(cluster.config.provider["project-id"]) }}
  gce-zone: {{ b64(cluster.config.provider.zone) }}
  database-url: {{ b64("postgresql://%s:%s@api-database.kel-system/%s"|format(cluster.config.api.database.username, cluster.config.api.database.password, cluster.config.api.database.name)) }}
  redis-url: {{ b64("redis://api-cache.kel-system/0") }}
  identity-url: {{ b64(cluster.config["identity-url"]) }}{% if cluster.config.api.get("opbeat") %}
  opbeat: {{ b64(cluster.config.api.opbeat) }}
  client-version: {{ b64(cluster.config["client-version"]) }}
  client-download-url: {{ b64(cluster.config["client-download-url"]) }}
{% endif %}
